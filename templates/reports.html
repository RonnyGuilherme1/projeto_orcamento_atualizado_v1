{% extends "base_app.html" %}
{% set page_class = 'page-reports' %}
{% set page_css = ['/static/css/app_shell.css', '/static/css/app_base.css', '/static/css/reports.css'] %}

{% block title %}Relatórios | Controle Financeiro{% endblock %}
{% block page_title %}Relatórios{% endblock %}

{% block content %}
  {% set locked = not has_feature('reports') %}
  <div class="page reports-page{% if locked %} is-locked{% endif %}" data-reports-page>
    <section class="panel reports-hero">
      <div class="reports-hero-top">
        <div class="reports-hero-title">
          <span class="pill pro-pill">Plano PRO</span>
          <h2 class="panel-title">Relatórios</h2>
          <p class="panel-subtitle">Gere relatórios completos do seu período, exporte e imprima para uso oficial.</p>
        </div>
        <div class="reports-hero-actions">
          <button class="btn-secondary" type="button" data-export="pdf">Gerar PDF</button>
          <button class="btn-secondary" type="button" data-export="excel">Exportar Excel</button>
          <button class="btn-secondary" type="button" data-export="print">Imprimir</button>
        </div>
      </div>

      <div class="reports-filters">
        <label class="field">
          <span class="field-label">Período</span>
          <select id="reports-period" class="control">
            <option value="month">Mês atual</option>
            <option value="30">Últimos 30 dias</option>
            <option value="quarter">Trimestre</option>
            <option value="year">Ano</option>
            <option value="custom">Personalizado</option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Regime</span>
          <select id="reports-mode" class="control">
            <option value="cash">Caixa (pago/recebido)</option>
            <option value="accrual">Competência (vencimento)</option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Tipo</span>
          <select id="reports-type" class="control">
            <option value="all">Ambos</option>
            <option value="income">Receitas</option>
            <option value="expense">Despesas</option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Status</span>
          <select id="reports-status-filter" class="control">
            <option value="all">Todos</option>
            <option value="paid">Pago/Recebido</option>
            <option value="pending">Pendente</option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Categoria</span>
          <select id="reports-category" class="control" multiple>
            <option value="salario">Salário</option>
            <option value="extras">Extras</option>
            <option value="moradia">Moradia</option>
            <option value="mercado">Mercado</option>
            <option value="transporte">Transporte</option>
            <option value="servicos">Serviços</option>
            <option value="outros">Outros</option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Método</span>
          <select id="reports-method" class="control" multiple>
            <option value="pix">PIX</option>
            <option value="cartao">Cartão</option>
            <option value="credito">Crédito</option>
            <option value="debito">Débito</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="boleto">Boleto</option>
          </select>
        </label>
      </div>

      <div class="reports-range" data-range>
        <label class="field">
          <span class="field-label">De</span>
          <input type="date" class="control" id="reports-start" />
        </label>
        <label class="field">
          <span class="field-label">Até</span>
          <input type="date" class="control" id="reports-end" />
        </label>
      </div>

      <div class="reports-hero-footer">
        <span class="reports-status" id="reports-status">Atualizado: —</span>
        <button class="btn-secondary" type="button">Salvar modelo</button>
      </div>
    </section>

    <section class="reports-grid">
      <section class="panel reports-summary">
        <div class="panel-head">
          <div>
            <h3 class="panel-title">Resumo executivo</h3>
            <p class="panel-subtitle">Indicadores gerenciais para decisões rápidas.</p>
          </div>
          <div class="panel-actions">
            <span class="report-pill">Gerencial</span>
          </div>
        </div>

        <div class="report-cards">
          <article class="report-card">
            <h4>Resultado do período</h4>
            <div class="report-metric">
              <div>
                <span>Total receitas</span>
                <strong id="report-total-income">R$ —</strong>
              </div>
              <div>
                <span>Total despesas</span>
                <strong id="report-total-expense">R$ —</strong>
              </div>
            </div>
            <div class="report-highlight positive" id="report-net-highlight">
              Resultado líquido: <span id="report-net-result">R$ —</span> <span id="report-net-pct">(—)</span>
            </div>
          </article>

          <article class="report-card">
            <h4>Comparativo</h4>
            <div class="report-metric">
              <div>
                <span>Vs período anterior</span>
                <strong id="report-compare-prev">—</strong>
              </div>
              <div>
                <span>Vs média 3 meses</span>
                <strong id="report-compare-avg">—</strong>
              </div>
            </div>
            <div class="report-highlight warning" id="report-compare-note">—</div>
          </article>

          <article class="report-card">
            <h4>Saúde financeira</h4>
            <div class="report-metric">
              <div>
                <span>Índice de equilíbrio</span>
                <strong id="report-health-index">—</strong>
              </div>
              <div>
                <span>Status</span>
                <strong id="report-health-status">—</strong>
              </div>
            </div>
            <ul class="report-alerts" id="report-alerts">
              <li>—</li>
            </ul>
          </article>

          <article class="report-card">
            <h4>Pendências e impacto</h4>
            <div class="report-metric">
              <div>
                <span>Contas pendentes</span>
                <strong id="report-pending-count">—</strong>
              </div>
              <div>
                <span>Total pendente</span>
                <strong id="report-pending-total">R$ —</strong>
              </div>
            </div>
            <div class="report-highlight negative" id="report-pending-impact">Saldo se pagar tudo hoje: R$ —</div>
          </article>
        </div>
      </section>

      <section class="panel reports-tabs">
        <div class="tabs-head">
          <div class="tabs">
            <button class="tab-btn is-active" type="button" data-tab="dre">DRE</button>
            <button class="tab-btn" type="button" data-tab="flow">Fluxo de caixa</button>
            <button class="tab-btn" type="button" data-tab="categories">Categorias</button>
            <button class="tab-btn" type="button" data-tab="recurring">Recorrências</button>
            <button class="tab-btn" type="button" data-tab="pending">Pendências</button>
          </div>
          <div class="tabs-actions">
            <span class="tab-hint">Relatórios analíticos</span>
          </div>
        </div>

        <div class="tab-panels">
          <div class="tab-panel is-active" data-tab="dre">
            <div class="panel-subhead">
              <div>
                <h4>DRE pessoal (Demonstrativo)</h4>
                <p>Consolidação de receitas e despesas por categoria.</p>
              </div>
              <button class="btn-secondary" type="button" data-export="pdf">Exportar PDF</button>
            </div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th>Total receitas</th>
                  <th>Total despesas</th>
                  <th>Resultado</th>
                </tr>
              </thead>
              <tbody id="dre-body"></tbody>
            </table>
          </div>

          <div class="tab-panel" data-tab="flow">
            <div class="panel-subhead">
              <div>
                <h4>Fluxo de caixa detalhado</h4>
                <p>Timeline completa com saldo acumulado.</p>
              </div>
              <button class="btn-secondary" type="button" data-export="excel">Exportar Excel</button>
            </div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descrição</th>
                  <th>Categoria</th>
                  <th>Método</th>
                  <th>Entrada</th>
                  <th>Saída</th>
                  <th>Saldo acumulado</th>
                </tr>
              </thead>
              <tbody id="flow-body"></tbody>
            </table>
          </div>

          <div class="tab-panel" data-tab="categories">
            <div class="panel-subhead">
              <div>
                <h4>Despesas por categoria</h4>
                <p>Top categorias, variação e participação.</p>
              </div>
            </div>
            <div class="category-report">
              <div class="category-chart" id="category-chart"></div>
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Categoria</th>
                    <th>Total</th>
                    <th>%</th>
                    <th>Variação</th>
                  </tr>
                </thead>
                <tbody id="category-body"></tbody>
              </table>
            </div>
          </div>

          <div class="tab-panel" data-tab="recurring">
            <div class="panel-subhead">
              <div>
                <h4>Receitas recorrentes &amp; previsibilidade</h4>
                <p>Fontes recorrentes detectadas automaticamente.</p>
              </div>
            </div>
            <div class="recurring-grid" id="recurring-grid"></div>
          </div>

          <div class="tab-panel" data-tab="pending">
            <div class="panel-subhead">
              <div>
                <h4>Inadimplência &amp; pendências</h4>
                <p>Impacto no caixa caso regularize tudo hoje.</p>
              </div>
            </div>
            <div class="pending-grid">
              <div class="pending-card">
                <h5>Resumo rápido</h5>
                <ul id="pending-summary">
                  <li>Vencidas: —</li>
                  <li>Vencem em 7 dias: —</li>
                  <li>Impacto no saldo: —</li>
                </ul>
              </div>
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Vencimento</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Valor</th>
                    <th>Dias atraso</th>
                  </tr>
                </thead>
                <tbody id="pending-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="panel reports-export">
        <div class="panel-head">
          <div>
            <h3 class="panel-title">Central de exportação</h3>
            <p class="panel-subtitle">Escolha o que entra no PDF e gere seu relatório oficial.</p>
          </div>
        </div>
        <div class="export-grid">
          <div class="export-options">
            <label class="check-row"><input type="checkbox" data-export-section="summary" checked /> Resumo executivo</label>
            <label class="check-row"><input type="checkbox" data-export-section="dre" checked /> DRE</label>
            <label class="check-row"><input type="checkbox" data-export-section="flow" checked /> Fluxo de caixa</label>
            <label class="check-row"><input type="checkbox" data-export-section="categories" /> Categorias</label>
            <label class="check-row"><input type="checkbox" data-export-section="recurring" /> Recorrências</label>
            <label class="check-row"><input type="checkbox" data-export-section="pending" /> Pendências</label>
          </div>
          <div class="export-details">
            <div class="detail-control" data-detail-control>
              <span class="field-label">Detalhamento</span>
              <div class="detail-segmented" role="tablist" aria-label="Detalhamento do relatório">
                <button class="detail-segment is-active" type="button" data-detail="resumido" aria-pressed="true">
                  Resumido
                </button>
                <button class="detail-segment" type="button" data-detail="detalhado" aria-pressed="false">
                  Detalhado
                </button>
              </div>
              <div class="detail-microcopy">
                <p class="detail-copy is-active" data-detail-copy="resumido">
                  Visão executiva (menos páginas)
                </p>
                <p class="detail-copy" data-detail-copy="detalhado">
                  Relatório completo (linha a linha, mais páginas)
                </p>
              </div>
            </div>
            <div class="export-actions">
              <button class="btn-primary" type="button" data-export="pdf">Gerar PDF agora</button>
              <button class="btn-secondary" type="button" data-export="excel">Exportar Excel</button>
            </div>
          </div>
        </div>
      </section>
    </section>

    {% if locked %}
      <div class="reports-lock">
        <div class="lock-card">
          <span class="pill">Plano PRO</span>
          <h3>Relatórios completos são exclusivos do Plano Pro</h3>
          <p>Desbloqueie PDFs oficiais, exportações e análises avançadas.</p>
          <a class="btn-primary" href="/app/upgrade">Desbloquear no PRO</a>
        </div>
      </div>
    {% endif %}

    <div class="pdf-modal" id="reports-pdf-modal" aria-hidden="true">
      <div class="pdf-backdrop" data-pdf-close></div>
      <div class="pdf-shell" role="dialog" aria-modal="true" aria-label="Pré-visualização do relatório">
        <div class="pdf-header">
          <button class="pdf-close" type="button" aria-label="Fechar" data-pdf-close>&times;</button>
        </div>
        <div class="pdf-body">
          <iframe class="pdf-frame" data-pdf-frame title="Pré-visualização do relatório"></iframe>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="/static/js/pages/reports.js"></script>
{% endblock %}
