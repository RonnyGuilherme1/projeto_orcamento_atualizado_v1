{% extends "base_app.html" %}
{% set page_class = 'page-charts' %}
{% set page_css = ['/static/css/app_shell.css', '/static/css/app_base.css', '/static/css/charts.css'] %}

{% block title %}Gr√°ficos{% endblock %}
{% block page_title %}Gr&aacute;ficos{% endblock %}

{% block content %}
  <div class="page charts-page" data-page="charts">
    <section class="panel charts-topbar">
      <div class="topbar-grid">
        <div class="topbar-text">
          <span class="plus-pill">Plano Plus</span>
          <h2 class="panel-title">Gr&aacute;ficos Plus</h2>
          <p class="panel-subtitle">Mais controles, compara&ccedil;&otilde;es e insights para decis&otilde;es r&aacute;pidas.</p>
        </div>
        <div class="topbar-actions">
          <div class="period-block">
            <span class="field-label">Per&iacute;odo</span>
            <div class="segmented" id="period-tabs" role="tablist">
              <button class="segmented-btn is-active" type="button" data-period="month" role="tab" aria-selected="true" title="Analisar o m&ecirc;s selecionado">M&ecirc;s</button>
              <button class="segmented-btn" type="button" data-period="quarter" role="tab" aria-selected="false" title="Comparar por trimestre">Trimestre</button>
              <button class="segmented-btn" type="button" data-period="custom" role="tab" aria-selected="false" title="Definir um intervalo personalizado">Personalizado</button>
            </div>
            <div class="period-panels">
              <div class="period-panel is-active" data-period-panel="month" role="tabpanel">
                <label class="field field-inline">
                  <span class="field-label">Ano</span>
                  <select id="chart-year" class="control">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                  </select>
                </label>
                <label class="field field-inline">
                  <span class="field-label">M&ecirc;s</span>
                  <select id="chart-month" class="control">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Mar&ccedil;o</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                  </select>
                </label>
              </div>
              <div class="period-panel" data-period-panel="quarter" role="tabpanel" aria-hidden="true">
                <label class="field field-inline">
                  <span class="field-label">Ano</span>
                  <select id="chart-year-quarter" class="control">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                  </select>
                </label>
                <label class="field field-inline">
                  <span class="field-label">Trimestre</span>
                  <select id="chart-quarter" class="control">
                    <option value="1">1&ordm; Trimestre</option>
                    <option value="2">2&ordm; Trimestre</option>
                    <option value="3">3&ordm; Trimestre</option>
                    <option value="4">4&ordm; Trimestre</option>
                  </select>
                </label>
              </div>
              <div class="period-panel" data-period-panel="custom" role="tabpanel" aria-hidden="true">
                <label class="field field-inline">
                  <span class="field-label">De</span>
                  <input id="chart-start" type="date" class="control" />
                </label>
                <label class="field field-inline">
                  <span class="field-label">At&eacute;</span>
                  <input id="chart-end" type="date" class="control" />
                </label>
              </div>
            </div>
          </div>

          <div class="compare-block">
            <span class="field-label">Compara&ccedil;&atilde;o</span>
            <label class="switch" title="Comparar com o per&iacute;odo anterior">
              <input id="compare-toggle" type="checkbox" checked />
              <span class="switch-track"></span>
              <span class="switch-text">M&ecirc;s anterior</span>
            </label>
            <span class="compare-meta" id="compare-label">Comparando com m&ecirc;s anterior</span>
          </div>

          <div class="export-block">
            <span class="field-label">Exportar</span>
            <div class="export-dropdown">
              <button class="btn btn-ghost" type="button" id="export-trigger" title="Exportar dados e gr&aacute;ficos">Exportar</button>
              <div class="export-menu" id="export-menu" role="menu">
                <button type="button" data-export="csv" role="menuitem">CSV do per&iacute;odo</button>
                <button type="button" data-export="json" role="menuitem">JSON completo</button>
                <button type="button" data-export="svg" role="menuitem">SVG do gr&aacute;fico</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="kpi-grid">
      <article class="panel kpi-card" data-kpi="income">
        <div class="kpi-head">
          <span class="kpi-label">Receitas</span>
          <span class="kpi-chip" id="kpi-income-chip">Neutro</span>
        </div>
        <strong id="kpi-income-value">R$ 0,00</strong>
        <div class="kpi-delta" id="kpi-income-delta">+R$ 0,00 (+0%)</div>
      </article>

      <article class="panel kpi-card" data-kpi="expense">
        <div class="kpi-head">
          <span class="kpi-label">Despesas</span>
          <span class="kpi-chip" id="kpi-expense-chip">Neutro</span>
        </div>
        <strong id="kpi-expense-value">R$ 0,00</strong>
        <div class="kpi-delta" id="kpi-expense-delta">+R$ 0,00 (+0%)</div>
      </article>

      <article class="panel kpi-card" data-kpi="balance">
        <div class="kpi-head">
          <span class="kpi-label">Saldo do per&iacute;odo</span>
          <span class="kpi-chip" id="kpi-balance-chip">Neutro</span>
        </div>
        <strong id="kpi-balance-value">R$ 0,00</strong>
        <div class="kpi-delta" id="kpi-balance-delta">+R$ 0,00 (+0%)</div>
      </article>

      <article class="panel kpi-card" data-kpi="entries">
        <div class="kpi-head">
          <span class="kpi-label">Entradas</span>
          <span class="kpi-chip" id="kpi-entries-chip">Neutro</span>
        </div>
        <strong id="kpi-entries-value">0 lan&ccedil;amentos</strong>
        <div class="kpi-delta" id="kpi-entries-delta">+0 (+0%)</div>
      </article>
    </section>

    <section class="charts-grid">
      <article class="panel chart-card span-2 main-chart">
        <div class="chart-head">
          <div>
            <h3>Fluxo do per&iacute;odo</h3>
            <p id="chart-period-label">Carregando...</p>
          </div>
          <div class="chart-head-actions">
            <div class="chip-group" id="series-toggle">
              <button class="chip is-active" type="button" data-series="income">Receitas</button>
              <button class="chip is-active" type="button" data-series="expense">Despesas</button>
              <button class="chip is-active" type="button" data-series="balance">Saldo</button>
            </div>
            <div class="meta-controls">
              <label class="field field-inline field-meta">
                <span class="field-label">Meta de saldo</span>
                <input id="goal-line-input" class="control" type="text" inputmode="decimal" placeholder="R$ 0,00" title="Defina uma meta de saldo" />
              </label>
              <label class="switch small" title="Exibir linha de meta no gr&aacute;fico">
                <input id="goal-line-toggle" type="checkbox" />
                <span class="switch-track"></span>
                <span class="switch-text">Meta</span>
              </label>
            </div>
          </div>
        </div>

        <div class="chart-canvas chart-line" id="line-canvas">
          <svg class="chart-svg" id="line-svg" viewBox="0 0 640 220" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="incomeFill" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="rgba(76, 175, 80, 0.42)" />
                <stop offset="100%" stop-color="rgba(76, 175, 80, 0.02)" />
              </linearGradient>
              <linearGradient id="expenseFill" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="rgba(245, 166, 35, 0.36)" />
                <stop offset="100%" stop-color="rgba(245, 166, 35, 0.02)" />
              </linearGradient>
            </defs>
            <path class="area-income" data-area="income" d="M0 180 L640 180 L640 220 L0 220 Z" />
            <path class="area-expense" data-area="expense" d="M0 190 L640 190 L640 220 L0 220 Z" />
            <path class="line-income" data-line="income" d="M0 180 L640 180" />
            <path class="line-expense" data-line="expense" d="M0 190 L640 190" />
            <path class="line-balance" data-line="balance" d="M0 170 L640 170" />
            <line class="line-ref line-zero" data-ref="zero" x1="0" y1="110" x2="640" y2="110" />
            <line class="line-ref line-goal" data-ref="goal" x1="0" y1="110" x2="640" y2="110" />
            <circle class="line-point" data-point="income" cx="0" cy="180" r="4" />
            <circle class="line-point" data-point="expense" cx="0" cy="190" r="4" />
            <circle class="line-point alt" data-point="balance" cx="0" cy="170" r="4" />
          </svg>
          <div class="chart-guide" id="line-guide" aria-hidden="true"></div>
          <div class="chart-tooltip" id="line-tooltip" aria-hidden="true">
            <span class="tooltip-type" id="line-tooltip-type">Receita</span>
            <strong class="tooltip-value" id="line-tooltip-value">R$ 0,00</strong>
            <span class="tooltip-date" id="line-tooltip-date">00/00/0000</span>
          </div>
          <div class="chart-empty">Sem dados no per&iacute;odo</div>
          <div class="chart-skeleton" data-skeleton>
            <div class="skeleton-line w-50"></div>
            <div class="skeleton-line w-70"></div>
            <div class="skeleton-line w-40"></div>
          </div>
        </div>

        <div class="chart-footer">
          <div class="chart-kpi">
            <span class="kpi-label">Melhor per&iacute;odo</span>
            <strong id="kpi-best-period">R$ 0,00</strong>
            <span class="kpi-meta" id="kpi-best-period-label">-</span>
          </div>
          <div class="chart-kpi">
            <span class="kpi-label">Maior sa&iacute;da</span>
            <strong id="kpi-top-expense">R$ 0,00</strong>
            <span class="kpi-meta" id="kpi-top-expense-label">-</span>
          </div>
          <div class="chart-kpi">
            <span class="kpi-label">Equil&iacute;brio</span>
            <strong id="kpi-equilibrio">0%</strong>
            <span class="kpi-meta" id="kpi-equilibrio-label">Despesas / receitas</span>
          </div>
        </div>
      </article>

      <article class="panel chart-card donut-card">
        <div class="chart-head">
          <div>
            <h3>Categorias em foco</h3>
            <p id="donut-subtitle">Top 5 do per&iacute;odo</p>
          </div>
          <div class="donut-controls">
            <div class="chip-group" id="donut-type-toggle">
              <button class="chip is-active" type="button" data-donut-type="expense">Despesas</button>
              <button class="chip" type="button" data-donut-type="income">Receitas</button>
            </div>
            <div class="chip-group" id="donut-top-toggle">
              <button class="chip is-active" type="button" data-donut-top="5">Top 5</button>
              <button class="chip" type="button" data-donut-top="10">Top 10</button>
              <button class="chip" type="button" data-donut-top="all">Todas</button>
            </div>
          </div>
        </div>

        <div class="chart-canvas donut-wrap" id="donut-canvas">
          <div class="donut" id="chart-donut" role="img" aria-label="Distribui&ccedil;&atilde;o de categorias">
            <div class="donut-center">
              <span class="donut-value" id="donut-total">R$ 0,00</span>
              <span class="donut-label" id="donut-label">Total do per&iacute;odo</span>
            </div>
          </div>
          <ul class="donut-legend" id="donut-legend"></ul>
          <div class="donut-hint">Clique em uma categoria para ver detalhes.</div>
          <div class="chart-empty">Sem dados no per&iacute;odo</div>
          <div class="chart-skeleton" data-skeleton>
            <div class="skeleton-circle"></div>
            <div class="skeleton-line w-60"></div>
            <div class="skeleton-line w-40"></div>
          </div>
        </div>
      </article>
    </section>

    <section class="insights-panel">
      <div class="panel insights-header">
        <div>
          <h3>Insights do per&iacute;odo</h3>
          <p>Alertas, oportunidades e padr&otilde;es para melhorar seu fluxo.</p>
        </div>
        <div class="insights-actions">
          <button class="btn btn-ghost" type="button" id="refresh-insights" title="Recalcular insights do per&iacute;odo">Atualizar insights</button>
        </div>
      </div>

      <div class="insights-grid">
        <article class="panel insight-card">
          <div class="insight-head">
            <h4>Alertas</h4>
            <span class="insight-pill">Aten&ccedil;&atilde;o</span>
          </div>
          <ul class="insight-list" id="insights-alerts"></ul>
        </article>

        <article class="panel insight-card">
          <div class="insight-head">
            <h4>Oportunidades</h4>
            <span class="insight-pill positive">Potencial</span>
          </div>
          <ul class="insight-list" id="insights-opportunities"></ul>
          <div class="insight-cta">
            {% if has_feature('filters') %}
              <button class="btn btn-primary" type="button" id="insight-create-rule" title="Criar uma nova regra de automa&ccedil;&atilde;o">
                Criar regra
              </button>
            {% else %}
              <button class="btn btn-primary is-locked" type="button" data-locked="true" data-tooltip="Dispon&iacute;vel no Plus" title="Dispon&iacute;vel no Plus" aria-disabled="true">
                <span class="lock-icon" aria-hidden="true">LOCK</span>
                Criar regra
              </button>
            {% endif %}
          </div>
        </article>

        <article class="panel insight-card">
          <div class="insight-head">
            <h4>Padr&otilde;es</h4>
            <span class="insight-pill">Tend&ecirc;ncias</span>
          </div>
          <ul class="insight-list" id="insights-patterns"></ul>
          <div class="insight-cta">
            <button class="btn btn-ghost" type="button" id="export-insights" title="Salvar insights em arquivo de texto">Exportar insights</button>
          </div>
        </article>
      </div>
    </section>

    <div class="modal-overlay" id="drilldown-overlay" aria-hidden="true">
      <div class="modal drilldown-modal" role="dialog" aria-modal="true" aria-labelledby="drilldown-title">
        <div class="modal-header">
          <h3 id="drilldown-title">Detalhes do per&iacute;odo</h3>
          <button class="modal-close" type="button" id="drilldown-close" aria-label="Fechar">&times;</button>
        </div>
        <div class="modal-body">
          <div class="drilldown-summary">
            <div>
              <span>Per&iacute;odo</span>
              <strong id="drilldown-period">-</strong>
            </div>
            <div>
              <span>Total</span>
              <strong id="drilldown-total">R$ 0,00</strong>
            </div>
          </div>
          <ul class="drilldown-list" id="drilldown-list"></ul>
          <div class="drilldown-empty" id="drilldown-empty">Sem lan&ccedil;amentos para este recorte.</div>
          <div class="drilldown-skeleton" data-skeleton>
            <div class="skeleton-line w-80"></div>
            <div class="skeleton-line w-70"></div>
            <div class="skeleton-line w-60"></div>
          </div>
        </div>
        <div class="modal-actions">
          <a class="btn btn-secondary" id="drilldown-cta" href="/app/entradas">Ver em Entradas</a>
          <button class="btn btn-ghost" type="button" id="drilldown-close-btn">Fechar</button>
        </div>
      </div>
    </div>

    <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="true"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="/static/js/pages/charts.js"></script>
{% endblock %}
