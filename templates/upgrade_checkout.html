{% extends "base_app.html" %}
{% set page_class = 'page-upgrade' %}
{% set page_css = ['/static/css/upgrade.css'] %}

{% block title %}Upgrade | Controle Financeiro{% endblock %}
{% block page_title %}Upgrade de plano{% endblock %}

{% block content %}
  {% set plan = PLANS.get(selected_plan, PLANS['basic']) %}

  <div class="app-card upgrade-checkout">
    <div class="upgrade-checkout-hero">
      <div class="upgrade-checkout-copy">
        <span class="upgrade-checkout-kicker">Checkout do plano</span>
        <h2>Confirmar upgrade</h2>
        <p class="upgrade-checkout-subtitle">
          Você está prestes a iniciar o checkout do <strong>{{ plan['name'] }}</strong>.
        </p>
      </div>
      <div class="upgrade-checkout-plan">
        <span class="upgrade-checkout-plan-label">Plano selecionado</span>
        <span class="upgrade-checkout-plan-pill">{{ plan['name'] }}</span>
        <span class="upgrade-checkout-plan-price">R$ {{ '%.2f'|format(plan['price_month']) }} / mês</span>
      </div>
    </div>

    <div class="checkout-grid">
      <div class="upgrade-checkout-card">
        <h3>Resumo</h3>
        <p>Plano: <strong>{{ plan['name'] }}</strong></p>
        <p>Valor: <strong>R$ {{ '%.2f'|format(plan['price_month']) }}</strong> (1 mês)</p>
        <p class="muted">
          {% if abacatepay_card_enabled %}
            O pagamento pode ser feito via PIX ou cartão. Após a confirmação, seu plano será atualizado automaticamente.
            <span class="upgrade-checkout-note">Cartão em beta: requer liberação no suporte da AbacatePay.</span>
          {% else %}
            O pagamento é feito via PIX. Após a confirmação, seu plano será atualizado automaticamente.
          {% endif %}
        </p>
      </div>

      <div class="upgrade-checkout-card">
        <h3>O que muda</h3>
        <ul class="plan-list">
          {% for item in plan['highlights'] %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="checkout-actions checkout-actions-center">
      <a class="btn-secondary" href="{{ url_for('analytics.upgrade') }}">Voltar</a>
      <form method="post" action="{{ url_for('analytics.upgrade_checkout_start') }}" style="margin:0;">
        <input type="hidden" name="plan" value="{{ selected_plan }}">
        <button class="btn-primary" type="submit">Ir para pagamento (PIX{% if abacatepay_card_enabled %} ou Cartão{% endif %})</button>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const form = document.querySelector('.upgrade-checkout form');
      if (!form) return;
      form.addEventListener('submit', () => {
        const btn = form.querySelector('button[type=\"submit\"]');
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = 'Iniciando pagamento...';
      });
    })();
  </script>
{% endblock %}
