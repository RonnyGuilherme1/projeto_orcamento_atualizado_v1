{% extends "base_app.html" %}
{% set page_class = 'page-account' %}
{% set page_css = ['/static/css/account.css'] %}

{% block page_title %}Minha conta{% endblock %}

{% set _plan = PLANS.get(current_user.plan, PLANS['basic']) %}

{% block content %}
  <section class="account-shell">
    <header class="account-header">
      <div class="account-title">
        <div class="account-avatar" aria-hidden="true">
          {{ (current_user.username[:2] if current_user.username else 'U')|upper }}
        </div>
        <div>
          <h2 class="account-h">Minha conta</h2>
          <p class="account-sub">Gerencie as informações de conta, dados pessoais e assinaturas</p>
        </div>
      </div>
    </header>

    <div class="account-grid">
      <nav class="account-nav" aria-label="Menu da conta">
        <a class="account-nav-item {% if section == 'overview' %}active{% endif %}" href="/app/account?section=overview">
          Visão geral
        </a>
        <a class="account-nav-item {% if section == 'billing' %}active{% endif %}" href="/app/account?section=billing">
          Assinaturas e compras
        </a>
        <a class="account-nav-item {% if section == 'access' %}active{% endif %}" href="/app/account?section=access">
          Dados de acesso
        </a>
        <a class="account-nav-item {% if section == 'profile' %}active{% endif %}" href="/app/account?section=profile">
          Dados pessoais
        </a>
        <a class="account-nav-item {% if section == 'notifications' %}active{% endif %}" href="/app/account?section=notifications">
          Preferências de notificação
        </a>
      </nav>

      <div class="account-main">
        {% if section == 'overview' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Assinaturas e compras</h3>
              <a class="account-link" href="/app/account?section=billing">Gerenciar</a>
            </div>
            <p class="account-muted">
              Seu plano atual é <strong>{{ _plan['name'] }}</strong>.
              {% if current_user.plan == 'basic' %}
                Faça upgrade para liberar recursos avançados.
              {% endif %}
            </p>
            <div class="account-actions">
              <a class="btn" href="/app/upgrade">Ver planos</a>
            </div>
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados de acesso</h3>
              <a class="account-link" href="/app/account?section=access">Alterar</a>
            </div>
            <div class="account-kv">
              <div>
                <div class="account-k">Usuário</div>
                <div class="account-v">{{ current_user.username }}</div>
              </div>
              <div>
                <div class="account-k">E-mail</div>
                <div class="account-v">{{ current_user.email or '—' }}</div>
              </div>
            </div>
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados pessoais</h3>
              <a class="account-link" href="/app/account?section=profile">Alterar</a>
            </div>
            <p class="account-muted">Mantenha seus dados atualizados. Esta seção pode ser ampliada depois (CPF, telefone, endereço, etc.).</p>
          </div>

        {% elif section == 'billing' %}
          {% set sub = subscription or {} %}
          {% set renew_blocked = sub.status == 'ACTIVE' and (sub.days_left or 0) > 5 %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Assinaturas e compras</h3>
              <span class="account-badge {% if sub.status == 'ACTIVE' %}is-active{% elif sub.status == 'OVERDUE' %}is-overdue{% else %}is-inactive{% endif %}">
                {% if sub.status == 'ACTIVE' %}
                  Ativa
                {% elif sub.status == 'OVERDUE' %}
                  Pagamento pendente
                {% else %}
                  Sem pagamento
                {% endif %}
              </span>
            </div>

            <div class="account-kv">
              <div>
                <div class="account-k">Plano</div>
                <div class="account-v">{{ _plan['name'] }}</div>
              </div>
              <div>
                <div class="account-k">Valido ate</div>
                <div class="account-v">{{ sub.expires_at_display }}</div>
              </div>
              <div>
                <div class="account-k">Ultimo pagamento</div>
                <div class="account-v">{{ sub.last_paid_display }}</div>
              </div>
              <div>
                <div class="account-k">Dias restantes</div>
                <div class="account-v">{{ sub.days_left }}</div>
              </div>
            </div>

            <p class="account-muted" style="margin-top:10px;">
              {% if sub.status == 'ACTIVE' %}
                Sua assinatura esta ativa. Voce pode renovar a qualquer momento.
              {% elif sub.status == 'OVERDUE' %}
                Seu pagamento venceu. O acesso fica bloqueado ate a confirmacao do pagamento.
              {% else %}
                Nenhum pagamento ativo. Conclua o pagamento para liberar o acesso.
              {% endif %}
            </p>

            <div class="account-actions">
              <a class="btn btn-ghost" href="/app/upgrade">Trocar plano</a>
              <form method="post" action="{{ url_for('billing_renew') }}" style="margin:0;">
                <button class="btn" type="submit" {% if renew_blocked %}disabled aria-disabled="true" title="Renovacao liberada quando faltarem 5 dias"{% endif %}>
                  {% if sub.status == 'ACTIVE' %}Renovar agora{% else %}Pagar agora{% endif %}
                </button>
              </form>
            </div>
            {% if renew_blocked %}
              <p class="account-muted" style="margin-top:8px;">
                Renovacao liberada quando faltarem 5 dias ou menos.
              </p>
            {% endif %}
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Historico de pagamentos</h3>
            </div>
            {% if billing_history %}
              <div class="account-history">
                <div class="history-row history-head">
                  <div>Data</div>
                  <div>Plano</div>
                  <div>Status</div>
                  <div>Valor</div>
                </div>
                {% for item in billing_history %}
                  {% set item_status_label = 'Pago' if item.status == 'PAID' else 'Pendente' if item.status == 'PENDING' else item.status %}
                  <div class="history-row">
                    <div>{{ item.date }}</div>
                    <div>{{ item.plan }}</div>
                    <div class="history-status history-{{ item.status|lower }}">{{ item_status_label }}</div>
                    <div>
                      {% if item.amount is not none %}
                        R$ {{ '%.2f'|format(item.amount) }}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="account-muted">Nenhum pagamento encontrado.</p>
            {% endif %}
          </div>

        {% elif section == 'access' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados de acesso</h3>
            </div>
            <div class="account-form-grid">
              <div class="account-field">
                <label class="account-label">Usuário</label>
                <div class="account-value">{{ current_user.username }}</div>
              </div>
              <div class="account-field">
                <label class="account-label">E-mail</label>
                <div class="account-value">{{ current_user.email or '—' }}</div>
              </div>
            </div>
            <p class="account-muted">Se você quiser, eu preparo o fluxo de alteração de senha e e-mail com validações e confirmação.</p>
          </div>

        {% elif section == 'profile' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados pessoais</h3>
            </div>
            <p class="account-muted">
              {% if abacatepay_card_enabled %}
                Esses dados são obrigatórios para iniciar o pagamento (PIX ou cartão).
              {% else %}
                Esses dados são obrigatórios para iniciar o pagamento (PIX).
              {% endif %}
            </p>

            <form method="post" action="/app/account/profile" class="account-form">
              <div class="account-form-grid">
                <div class="account-field">
                  <label class="account-label">Nome completo</label>
                  <input class="account-input" name="full_name" type="text" placeholder="Seu nome completo" value="{{ current_user.full_name or '' }}" required>
                </div>

                <div class="account-field">
                  <label class="account-label">CPF</label>
                  <input class="account-input" name="tax_id" type="text" placeholder="000.000.000-00" value="{{ current_user.tax_id or '' }}" required>
                </div>

                <div class="account-field">
                  <label class="account-label">Telefone</label>
                  <input class="account-input" name="cellphone" type="text" placeholder="(00) 00000-0000" value="{{ current_user.cellphone or '' }}" required>
                </div>
              </div>

              <div class="account-actions">
                <button class="btn" type="submit">Salvar</button>
              </div>
            </form>
          </div>


        {% elif section == 'notifications' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Preferências de notificação</h3>
            </div>
            <p class="account-muted">Base pronta para adicionar preferências (e-mail, vencimentos, alertas). Pode ser conectado a jobs/cron depois.</p>
            <div class="account-actions">
              <button class="btn" disabled>Salvar</button>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
