{% extends "base_app.html" %}
{% set page_class = 'page-account' %}
{% set page_css = ['/static/css/account.css'] %}

{% block page_title %}Minha conta{% endblock %}

{% set _plan = PLANS.get(current_user.plan, PLANS['basic']) %}

{% block content %}
  <section class="account-shell">
    <header class="account-header">
      <div class="account-title">
        <div class="account-avatar" aria-hidden="true">
          {{ (current_user.username[:2] if current_user.username else 'U')|upper }}
        </div>
        <div>
          <h2 class="account-h">Minha conta</h2>
          <p class="account-sub">Gerencie as informações de conta, dados pessoais e assinaturas</p>
        </div>
      </div>
    </header>

    <div class="account-grid">
      <nav class="account-nav" aria-label="Menu da conta">
        <a class="account-nav-item {% if section == 'overview' %}active{% endif %}" href="/app/account?section=overview">
          Visão geral
        </a>
        <a class="account-nav-item {% if section == 'billing' %}active{% endif %}" href="/app/account?section=billing">
          Assinaturas e compras
        </a>
        <a class="account-nav-item {% if section == 'access' %}active{% endif %}" href="/app/account?section=access">
          Dados de acesso
        </a>
        <a class="account-nav-item {% if section == 'profile' %}active{% endif %}" href="/app/account?section=profile">
          Dados pessoais
        </a>
        <a class="account-nav-item {% if section == 'notifications' %}active{% endif %}" href="/app/account?section=notifications">
          Preferências de notificação
        </a>
      </nav>

      <div class="account-main">
        {% if section == 'overview' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Assinaturas e compras</h3>
              <a class="account-link" href="/app/account?section=billing">Gerenciar</a>
            </div>
            <p class="account-muted">
              Seu plano atual é <strong>{{ _plan['name'] }}</strong>.
              {% if current_user.plan == 'basic' %}
                Faça upgrade para liberar recursos avançados.
              {% endif %}
            </p>
            <div class="account-actions">
              <a class="btn" href="/app/upgrade">Ver planos</a>
            </div>
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados de acesso</h3>
              <a class="account-link" href="/app/account?section=access">Alterar</a>
            </div>
            <div class="account-kv">
              <div>
                <div class="account-k">Usuário</div>
                <div class="account-v">{{ current_user.username }}</div>
              </div>
              <div>
                <div class="account-k">E-mail</div>
                <div class="account-v">{{ current_user.email or '—' }}</div>
              </div>
            </div>
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados pessoais</h3>
              <a class="account-link" href="/app/account?section=profile">Alterar</a>
            </div>
            <p class="account-muted">Mantenha seus dados atualizados. Esta seção pode ser ampliada depois (CPF, telefone, endereço, etc.).</p>
          </div>

        {% elif section == 'billing' %}
          {% set sub = subscription or {} %}
          {% set renew_blocked = sub.status == 'ACTIVE' and (sub.days_left or 0) > 5 %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Assinaturas e compras</h3>
              <span class="account-badge {% if sub.status == 'ACTIVE' %}is-active{% elif sub.status == 'OVERDUE' %}is-overdue{% else %}is-inactive{% endif %}">
                {% if sub.status == 'ACTIVE' %}
                  Ativa
                {% elif sub.status == 'OVERDUE' %}
                  Pagamento pendente
                {% else %}
                  Sem pagamento
                {% endif %}
              </span>
            </div>

            <div class="account-kv">
              <div>
                <div class="account-k">Plano</div>
                <div class="account-v">{{ _plan['name'] }}</div>
              </div>
              <div>
                <div class="account-k">Valido ate</div>
                <div class="account-v">{{ sub.expires_at_display }}</div>
              </div>
              <div>
                <div class="account-k">Ultimo pagamento</div>
                <div class="account-v">{{ sub.last_paid_display }}</div>
              </div>
              <div>
                <div class="account-k">Dias restantes</div>
                <div class="account-v">{{ sub.days_left }}</div>
              </div>
            </div>

            {% if sub.status == 'OVERDUE' %}
              <p class="account-muted" style="margin-top:10px;">
                Seu pagamento venceu. O acesso fica bloqueado ate a confirmacao do pagamento.
              </p>
            {% elif sub.status != 'ACTIVE' %}
              <p class="account-muted" style="margin-top:10px;">
                Nenhum pagamento ativo. Conclua o pagamento para liberar o acesso.
              </p>
            {% endif %}

            <div class="account-actions">
              <a class="btn btn-ghost" href="/app/upgrade">Trocar plano</a>
              <form method="post" action="{{ url_for('billing_renew') }}" style="margin:0;">
                <button class="btn" type="submit" {% if renew_blocked %}disabled aria-disabled="true" title="Renovacao liberada quando faltarem 5 dias"{% endif %}>
                  {% if sub.status == 'ACTIVE' %}Renovar agora{% else %}Pagar agora{% endif %}
                </button>
              </form>
            </div>
            {% if renew_blocked %}
              <p class="account-muted" style="margin-top:8px;">
                Renovacao liberada quando faltarem 5 dias ou menos.
              </p>
            {% endif %}
          </div>

          <div class="account-card">
            <div class="account-card-h">
              <h3>Historico de pagamentos</h3>
            </div>
            {% if billing_history %}
              <div class="account-history">
                <div class="history-row history-head">
                  <div>Data</div>
                  <div>Plano</div>
                  <div>Status</div>
                  <div>Valor</div>
                </div>
                {% for item in billing_history %}
                  {% set item_status_label = 'Pago' if item.status == 'PAID' else 'Pendente' if item.status == 'PENDING' else item.status %}
                  <div class="history-row">
                    <div>{{ item.date }}</div>
                    <div>{{ item.plan }}</div>
                    <div class="history-status history-{{ item.status|lower }}">{{ item_status_label }}</div>
                    <div>
                      {% if item.amount is not none %}
                        R$ {{ '%.2f'|format(item.amount) }}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="account-muted">Nenhum pagamento encontrado.</p>
            {% endif %}
          </div>

        {% elif section == 'access' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados de acesso</h3>
            </div>
            <div class="account-form-grid">
              <div class="account-field">
                <label class="account-label">Usuário</label>
                <div class="account-value">{{ current_user.username }}</div>
              </div>
              <div class="account-field">
                <label class="account-label">E-mail atual</label>
                <div class="account-value">{{ current_user.email or '-' }}</div>
              </div>
            </div>

            <div class="account-actions" style="margin-top:12px;">
              <button class="btn" type="button" data-panel-target="email">Alterar email</button>
              <button class="btn btn-ghost" type="button" data-panel-target="password">Alterar senha</button>
            </div>

            <form method="post" action="{{ url_for('account_access_save') }}" class="account-form hidden" data-panel="email" style="margin-top:12px;">
              <div class="account-form-grid">
                <div class="account-field">
                  <label class="account-label">Novo e-mail</label>
                  <input class="account-input" name="new_email" type="email" placeholder="novo@email.com" autocomplete="email" required>
                </div>
                <div class="account-field">
                  <label class="account-label">Senha atual</label>
                  <input class="account-input" name="current_password" type="password" autocomplete="current-password" required>
                </div>
              </div>
              <div class="account-actions">
                <button class="btn" type="submit">Salvar e-mail</button>
              </div>
            </form>

            <form method="post" action="{{ url_for('account_access_save') }}" class="account-form hidden" data-panel="password" style="margin-top:12px;">
              <div class="account-form-grid">
                <div class="account-field">
                  <label class="account-label">Senha atual</label>
                  <input class="account-input" name="current_password" type="password" autocomplete="current-password" required>
                </div>
                <div class="account-field">
                  <label class="account-label">Nova senha</label>
                  <input class="account-input" name="new_password" type="password" autocomplete="new-password" required>
                </div>
                <div class="account-field">
                  <label class="account-label">Confirmar nova senha</label>
                  <input class="account-input" name="confirm_password" type="password" autocomplete="new-password" required>
                </div>
              </div>
              <div class="account-actions">
                <button class="btn" type="submit">Salvar senha</button>
              </div>
            </form>

            <script>
              (function () {
                const buttons = document.querySelectorAll("[data-panel-target]");
                const panels = document.querySelectorAll("[data-panel]");
                function togglePanel(name) {
                  let opened = false;
                  panels.forEach((panel) => {
                    const isTarget = panel.getAttribute("data-panel") === name;
                    if (isTarget && panel.classList.contains("hidden")) {
                      panel.classList.remove("hidden");
                      opened = true;
                    } else if (isTarget) {
                      panel.classList.add("hidden");
                    } else {
                      panel.classList.add("hidden");
                    }
                  });
                  if (opened) {
                    const focusField = document.querySelector('[data-panel="' + name + '"] input');
                    if (focusField) {
                      focusField.focus();
                    }
                  }
                }

                buttons.forEach((btn) => {
                  btn.addEventListener("click", () => togglePanel(btn.getAttribute("data-panel-target")));
                });
              })();
            </script>
          </div>

        {% elif section == 'profile' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Dados pessoais</h3>
            </div>
            <p class="account-muted">
              {% if abacatepay_card_enabled %}
                Esses dados são obrigatórios para iniciar o pagamento (PIX ou cartão).
              {% else %}
                Esses dados são obrigatórios para iniciar o pagamento (PIX).
              {% endif %}
            </p>

            <form method="post" action="/app/account/profile" class="account-form">
              <div class="account-form-grid">
                <div class="account-field">
                  <label class="account-label">Nome completo</label>
                  <input class="account-input" name="full_name" type="text" placeholder="Seu nome completo" value="{{ current_user.full_name or '' }}" required>
                </div>

                <div class="account-field">
                  <label class="account-label">CPF</label>
                  <input class="account-input" name="tax_id" type="text" placeholder="000.000.000-00" value="{{ current_user.tax_id or '' }}" required data-mask="cpf" inputmode="numeric" maxlength="14">
                </div>

                <div class="account-field">
                  <label class="account-label">Telefone</label>
                  <input class="account-input" name="cellphone" type="text" placeholder="(00) 00000-0000" value="{{ current_user.cellphone or '' }}" required data-mask="phone" inputmode="numeric" maxlength="15">
                </div>
              </div>

              <div class="account-actions">
                <button class="btn" type="submit">Salvar</button>
              </div>
            </form>
          </div>


        {% elif section == 'notifications' %}
          <div class="account-card">
            <div class="account-card-h">
              <h3>Preferências de notificação</h3>
            </div>
            <form method="post" action="/app/account/notifications" class="account-form">
              <div class="account-field">
                <label class="account-label">Alertas de vencimento</label>
                <label class="account-toggle">
                  <input type="checkbox" name="due_alert" value="1" {% if current_user.notify_due_alert %}checked{% endif %}>
                  <span>Exibir lembrete quando faltarem 5 dias do vencimento do plano.</span>
                </label>
              </div>
              <div class="account-actions">
                <button class="btn" type="submit">Salvar</button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/document_masks.js"></script>
{% endblock %}
