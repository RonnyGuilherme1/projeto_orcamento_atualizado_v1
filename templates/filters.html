{% extends "base_app.html" %}
{% set page_class = 'page-filters' %}
{% set page_css = ['/static/css/app_shell.css', '/static/css/app_base.css', '/static/css/filters.css'] %}

{% block title %}Regras & Automação | Controle Financeiro{% endblock %}
{% block page_title %}Regras & Automação{% endblock %}

{% block content %}
  <div class="page rules-page">
    <section class="panel rules-hero">
      <div class="panel-head">
        <div>
          <h2 class="panel-title">Regras & Automação</h2>
          <p class="panel-subtitle">Crie regras inteligentes, recorrências e lembretes para reduzir trabalho manual.</p>
        </div>
        <div class="panel-actions rules-hero-actions">
          <button class="btn-primary" type="button" id="rule-new">Nova regra</button>
          <button class="btn-secondary" type="button" data-recurrence-new>Nova recorrencia</button>
          <button class="btn-secondary" type="button" data-reminder-new>Novo lembrete</button>
        </div>
      </div>

      <div class="rules-banner">
        <strong>Recursos em desenvolvimento</strong>
        <span>Recorrencias e lembretes estao em desenvolvimento.</span>
      </div>

      <div class="rules-summary">
        <div class="summary-card">
          <span class="summary-label">Regras ativas</span>
          <strong id="summary-rules">0</strong>
          <span class="summary-meta">Configure regras para classificar entradas automaticamente.</span>
        </div>
        <div class="summary-card">
          <span class="summary-label">Recorrências</span>
          <strong id="summary-recurring">0</strong>
          <span class="summary-meta">Crie despesas fixas para não esquecer.</span>
        </div>
        <div class="summary-card">
          <span class="summary-label">Lembretes</span>
          <strong id="summary-reminders">0</strong>
          <span class="summary-meta">Alerte antes do vencimento.</span>
        </div>
      </div>
    </section>

    <section class="panel rules-section rules-templates">
      <div class="panel-head">
        <div>
          <h3 class="panel-title">Templates rápidos</h3>
          <p class="panel-subtitle">Comece com modelos prontos para reduzir fricção.</p>
        </div>
      </div>

      <div class="template-grid">
        <article class="template-card">
          <strong>Salário → Renda + recebido</strong>
          <p>Se descrição contém “Salário”.</p>
          <button class="btn-tertiary" type="button" data-template="salary">Usar template</button>
        </article>
        <article class="template-card">
          <strong>Uber → Transporte</strong>
          <p>Classificar automaticamente despesas.</p>
          <button class="btn-tertiary" type="button" data-template="uber">Usar template</button>
        </article>
        <article class="template-card">
          <strong>Aluguel mensal dia 5</strong>
          <p>Recorrência fixa com categoria Moradia.</p>
          <button class="btn-tertiary" type="button" data-template="rent">Usar template</button>
        </article>
        <article class="template-card">
          <strong>Lembrete 3 dias antes</strong>
          <p>Alerta antes do vencimento.</p>
          <button class="btn-tertiary" type="button" data-template="reminder">Usar template</button>
        </article>
        <article class="template-card">
          <strong>Revisar categoria Outros</strong>
          <p>Se valor &gt; R$ 200, pedir revisão.</p>
          <button class="btn-tertiary" type="button" data-template="review">Usar template</button>
        </article>
      </div>
    </section>

    <section class="panel rules-section">
      <div class="panel-head">
        <div>
          <h3 class="panel-title">Regras inteligentes</h3>
          <p class="panel-subtitle">Automatize categorias e status com base na descrição.</p>
        </div>
        <div class="panel-actions">
          <button class="btn-secondary" type="button" disabled>Importar regras</button>
        </div>
      </div>
      <div class="rules-tools">
        <div class="rules-applies">
          <span>Filtros para teste/aplicar:</span>
          <span class="rules-pill">Ao criar lancamento</span>
          <span class="rules-pill muted">Ao importar CSV</span>
          <span class="rules-pill muted">Ao editar</span>
        </div>
        <div class="rules-tool-grid">
          <label class="field">
            <span class="field-label">Periodo inicio</span>
            <input type="date" id="rules-filter-start" class="control">
          </label>
          <label class="field">
            <span class="field-label">Periodo fim</span>
            <input type="date" id="rules-filter-end" class="control">
          </label>
          <label class="field">
            <span class="field-label">Tipo</span>
            <select id="rules-filter-type" class="control">
              <option value="all">Todos</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Categoria</span>
            <select id="rules-filter-category" class="control">
              <option value="all">Todas</option>
              <option value="salario">Salario</option>
              <option value="extras">Extras</option>
              <option value="moradia">Moradia</option>
              <option value="mercado">Mercado</option>
              <option value="transporte">Transporte</option>
              <option value="servicos">Servicos</option>
              <option value="outros">Outros</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Status</span>
            <select id="rules-filter-status" class="control">
              <option value="all">Todos</option>
              <option value="pago">Pago</option>
              <option value="em_andamento">Em andamento</option>
              <option value="nao_pago">Nao pago</option>
              <option value="recebido">Recebido</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Valor minimo</span>
            <input type="number" step="0.01" id="rules-filter-min" class="control" placeholder="0.00">
          </label>
          <label class="field">
            <span class="field-label">Valor maximo</span>
            <input type="number" step="0.01" id="rules-filter-max" class="control" placeholder="0.00">
          </label>
          <label class="field">
            <span class="field-label">Limite teste</span>
            <input type="number" id="rules-filter-limit" class="control" value="200" min="1">
          </label>
        </div>
      </div>

      <div id="rules-output" class="rules-output hidden"></div>

      <ul class="rules-list" id="rules-list"></ul>
      <div class="rules-empty" id="rules-empty">Nenhuma regra criada.</div>
    </section>

    <section class="panel rules-section">
      <div class="panel-head">
        <div>
          <h3 class="panel-title">Recorrências</h3>
          <p class="panel-subtitle">Crie lançamentos automáticos para despesas fixas.</p>
        </div>
        <div class="panel-actions">
          <button class="btn-secondary" type="button" data-recurrence-new>Nova recorrencia</button>
          {% if not has_feature('filters') %}
            <a class="lock-pill" href="/app/upgrade?plan=plus">Disponível no Plus</a>
          {% endif %}
        </div>
      </div>

      <div class="rules-grid" id="recurrence-list"></div>
      <div class="rules-empty" id="recurrence-empty">Nenhuma recorrencia criada.</div>
    </section>

    <section class="panel rules-section">
      <div class="panel-head">
        <div>
          <h3 class="panel-title">Lembretes</h3>
          <p class="panel-subtitle">Receba alertas antes do vencimento das despesas.</p>
        </div>
        <div class="panel-actions">
          <button class="btn-secondary" type="button" data-reminder-new>Novo lembrete</button>
          {% if not has_feature('filters') %}
            <a class="lock-pill" href="/app/upgrade?plan=plus">Disponível no Plus</a>
          {% endif %}
        </div>
      </div>

      <div class="rules-grid" id="reminder-list"></div>
      <div class="rules-empty" id="reminder-empty">Nenhum lembrete criado.</div>
    </section>


    <div id="recurrence-modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 id="recurrence-modal-title">Nova recorrencia</h3>
          <button id="recurrence-modal-close" class="modal-close" type="button" aria-label="Fechar">&times;</button>
        </div>
        <form id="recurrence-form" class="modal-body">
          <input type="hidden" id="recurrence-id">

          <label class="field span-all">
            <span class="field-label">Nome</span>
            <input type="text" id="recurrence-name" class="control" placeholder="Ex: Aluguel">
          </label>

          <label class="field">
            <span class="field-label">Tipo</span>
            <select id="recurrence-type" class="control">
              <option value="despesa">Despesa</option>
              <option value="receita">Receita</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Dia do mes</span>
            <input type="number" id="recurrence-day" class="control" value="5" min="1" max="31">
          </label>

          <label class="field">
            <span class="field-label">Categoria</span>
            <select id="recurrence-category" class="control">
              <option value="salario">Salario</option>
              <option value="extras">Extras</option>
              <option value="moradia">Moradia</option>
              <option value="mercado">Mercado</option>
              <option value="transporte">Transporte</option>
              <option value="servicos">Servicos</option>
              <option value="outros">Outros</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Valor</span>
            <input type="number" step="0.01" id="recurrence-value" class="control" value="0">
          </label>

          <label class="field">
            <span class="field-label">Status</span>
            <select id="recurrence-status" class="control">
              <option value="">Sem status</option>
              <option value="em_andamento">Em andamento</option>
              <option value="pago">Pago</option>
              <option value="nao_pago">Nao pago</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Metodo</span>
            <select id="recurrence-method" class="control">
              <option value="">Nao informado</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="cartao">Cartao</option>
              <option value="pix">Pix</option>
            </select>
          </label>

          <label class="field span-all">
            <span class="field-label">Descricao</span>
            <input type="text" id="recurrence-description" class="control" placeholder="Ex: Aluguel mensal">
          </label>

          <label class="field span-all">
            <span class="field-label">Tags</span>
            <input type="text" id="recurrence-tags" class="control" placeholder="Ex: fixo, contrato">
          </label>

          <label class="field span-all">
            <label class="check-pill">
              <input type="checkbox" id="recurrence-enabled" checked>
              <span>Ativa</span>
            </label>
          </label>

          <div class="modal-actions">
            <button id="recurrence-modal-cancel" type="button" class="btn-secondary">Cancelar</button>
            <button type="submit" class="btn-primary">Salvar recorrencia</button>
          </div>
        </form>
      </div>
    </div>

    <div id="reminder-modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 id="reminder-modal-title">Novo lembrete</h3>
          <button id="reminder-modal-close" class="modal-close" type="button" aria-label="Fechar">&times;</button>
        </div>
        <form id="reminder-form" class="modal-body">
          <input type="hidden" id="reminder-id">

          <label class="field span-all">
            <span class="field-label">Nome</span>
            <input type="text" id="reminder-name" class="control" placeholder="Ex: Vencimentos">
          </label>

          <label class="field">
            <span class="field-label">Dias antes</span>
            <input type="number" id="reminder-days" class="control" value="3" min="1" max="60">
          </label>

          <label class="field">
            <span class="field-label">Tipo</span>
            <select id="reminder-type" class="control">
              <option value="">Todos</option>
              <option value="despesa">Despesa</option>
              <option value="receita">Receita</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Categoria</span>
            <select id="reminder-category" class="control">
              <option value="">Todas</option>
              <option value="salario">Salario</option>
              <option value="extras">Extras</option>
              <option value="moradia">Moradia</option>
              <option value="mercado">Mercado</option>
              <option value="transporte">Transporte</option>
              <option value="servicos">Servicos</option>
              <option value="outros">Outros</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Status</span>
            <select id="reminder-status" class="control">
              <option value="">Todos</option>
              <option value="em_andamento">Em andamento</option>
              <option value="pago">Pago</option>
              <option value="nao_pago">Nao pago</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Metodo</span>
            <select id="reminder-method" class="control">
              <option value="">Todos</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="cartao">Cartao</option>
              <option value="pix">Pix</option>
            </select>
          </label>

          <label class="field">
            <span class="field-label">Valor minimo</span>
            <input type="number" step="0.01" id="reminder-min" class="control" placeholder="0.00">
          </label>

          <label class="field">
            <span class="field-label">Valor maximo</span>
            <input type="number" step="0.01" id="reminder-max" class="control" placeholder="0.00">
          </label>

          <label class="field span-all">
            <label class="check-pill">
              <input type="checkbox" id="reminder-enabled" checked>
              <span>Ativo</span>
            </label>
          </label>

          <div class="modal-actions">
            <button id="reminder-modal-cancel" type="button" class="btn-secondary">Cancelar</button>
            <button type="submit" class="btn-primary">Salvar lembrete</button>
          </div>
        </form>
      </div>
    </div>
    <div id="rule-modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 id="rule-modal-title">Nova regra</h3>
          <button id="rule-modal-close" class="modal-close" type="button" aria-label="Fechar">&times;</button>
        </div>
        <form id="rule-form" class="modal-body">
          <input type="hidden" id="rule-id">

          <label class="field span-all">
            <span class="field-label">Nome</span>
            <input type="text" id="rule-name" class="control" placeholder="Ex: Salario recebido">
          </label>

          <label class="field">
            <span class="field-label">Prioridade</span>
            <input type="number" id="rule-priority" class="control" value="100" min="1">
          </label>

          <label class="field">
            <span class="field-label">Ativa</span>
            <label class="check-pill">
              <input type="checkbox" id="rule-enabled" checked>
              <span>Ativa</span>
            </label>
          </label>

          <div class="rule-group-title span-all">Aplicar em</div>
          <div class="rule-checks span-all">
            <label class="check-pill">
              <input type="checkbox" id="rule-on-create" checked>
              <span>Ao criar</span>
            </label>
            <label class="check-pill">
              <input type="checkbox" id="rule-on-edit">
              <span>Ao editar</span>
            </label>
            <label class="check-pill">
              <input type="checkbox" id="rule-on-import">
              <span>Ao importar</span>
            </label>
            <label class="check-pill">
              <input type="checkbox" id="rule-stop">
              <span>Parar apos aplicar</span>
            </label>
          </div>

          <div class="rule-group-title span-all">Condicoes</div>
          <label class="field span-all">
            <span class="field-label">Descricao contem</span>
            <input type="text" id="cond-description" class="control" placeholder="Ex: salario">
          </label>
          <label class="field">
            <span class="field-label">Tipo</span>
            <select id="cond-type" class="control">
              <option value="all">Todos</option>
              <option value="receita">Receita</option>
              <option value="despesa">Despesa</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Categoria</span>
            <select id="cond-category" class="control">
              <option value="all">Todas</option>
              <option value="salario">Salario</option>
              <option value="extras">Extras</option>
              <option value="moradia">Moradia</option>
              <option value="mercado">Mercado</option>
              <option value="transporte">Transporte</option>
              <option value="servicos">Servicos</option>
              <option value="outros">Outros</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Status</span>
            <select id="cond-status" class="control">
              <option value="all">Todos</option>
              <option value="pago">Pago</option>
              <option value="em_andamento">Em andamento</option>
              <option value="nao_pago">Nao pago</option>
              <option value="recebido">Recebido</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Valor minimo</span>
            <input type="number" step="0.01" id="cond-min" class="control" placeholder="0.00">
          </label>
          <label class="field">
            <span class="field-label">Valor maximo</span>
            <input type="number" step="0.01" id="cond-max" class="control" placeholder="0.00">
          </label>
          <label class="field">
            <span class="field-label">Metodo</span>
            <select id="cond-method" class="control">
              <option value="all">Todos</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="cartao">Cartao</option>
              <option value="pix">Pix</option>
            </select>
          </label>

          <div class="rule-group-title span-all">Acoes</div>
          <label class="field">
            <span class="field-label">Categoria</span>
            <select id="action-category" class="control">
              <option value="">Sem acao</option>
              <option value="salario">Salario</option>
              <option value="extras">Extras</option>
              <option value="moradia">Moradia</option>
              <option value="mercado">Mercado</option>
              <option value="transporte">Transporte</option>
              <option value="servicos">Servicos</option>
              <option value="outros">Outros</option>
            </select>
          </label>
          <label class="field">
            <span class="field-label">Status</span>
            <select id="action-status" class="control">
              <option value="">Sem acao</option>
              <option value="pago">Pago</option>
              <option value="em_andamento">Em andamento</option>
              <option value="nao_pago">Nao pago</option>
              <option value="recebido">Recebido</option>
            </select>
          </label>
          <label class="field span-all">
            <span class="field-label">Tags</span>
            <input type="text" id="action-tags" class="control" placeholder="Ex: revisar, mobilidade">
          </label>
          <label class="field span-all">
            <span class="field-label">Prefixo da descricao</span>
            <input type="text" id="action-prefix" class="control" placeholder="Ex: Cartao: ">
          </label>
          <label class="field">
            <span class="field-label">Metodo</span>
            <select id="action-method" class="control">
              <option value="">Sem acao</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="cartao">Cartao</option>
              <option value="pix">Pix</option>
            </select>
          </label>

          <div class="modal-actions">
            <button id="rule-modal-cancel" type="button" class="btn-secondary">Cancelar</button>
            <button type="submit" class="btn-primary">Salvar regra</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="/static/js/pages/filters.js"></script>
{% endblock %}
