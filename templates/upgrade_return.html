{% extends "base_app.html" %}
{% set page_class = 'page-upgrade' %}
{% set page_css = ['/static/css/upgrade.css'] %}

{% block title %}Pagamento em processamento | Controle Financeiro{% endblock %}
{% block page_title %}Pagamento{% endblock %}

{% block content %}
  {% set plan = PLANS.get(order.plan, PLANS['basic']) %}
  {% set back_url = back_url or url_for('analytics.upgrade') %}
  {% set status_url = status_url or url_for('analytics.upgrade_status', token=order.token) %}
  {% set status_label = 'Pago' if order.status == 'PAID' else 'Pendente' if order.status == 'PENDING' else order.status %}

  <div class="app-card">
    <h2>Estamos confirmando o seu pagamento</h2>
    <p class="muted">Assim que a confirmação chegar, o seu plano será atualizado automaticamente.</p>

    <div class="app-card upgrade-return-status">
      <div class="status-grid">
        <div class="status-item">
          <span class="status-label">Plano</span>
          <strong>{{ plan['name'] }}</strong>
        </div>
        <div class="status-item">
          <span class="status-label">Status</span>
          <span id="status-text" class="status-pill {% if order.status == 'PAID' %}status-paid{% else %}status-pending{% endif %}">
            {{ status_label }}
          </span>
        </div>
      </div>
    </div>

    <div class="upgrade-return-actions">
      <a class="btn-secondary btn-pill" href="{{ back_url }}">Voltar</a>
      <button class="btn-primary btn-pill" type="button" id="refresh-status">Atualizar status</button>
    </div>

    <p class="muted" style="margin-top:12px;">
      Se você já pagou e o status não atualizar, aguarde alguns minutos e tente novamente.
    </p>
    <p id="status-warning" class="muted" style="margin-top:8px; display:none;"></p>
  </div>

  <div class="app-card upgrade-history">
    <h3>Historico de pagamentos</h3>
    {% if billing_history %}
      <div class="history-row history-head">
        <div>Data</div>
        <div>Plano</div>
        <div>Status</div>
        <div>Valor</div>
      </div>
      {% for item in billing_history %}
        {% set item_status_label = 'Pago' if item.status == 'PAID' else 'Pendente' if item.status == 'PENDING' else item.status %}
        <div class="history-row">
          <div>{{ item.date }}</div>
          <div>{{ item.plan }}</div>
          <div class="history-status history-{{ item.status|lower }}">{{ item_status_label }}</div>
          <div>
            {% if item.amount is not none %}
              R$ {{ '%.2f'|format(item.amount) }}
            {% else %}
              -
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Nenhum pagamento encontrado.</p>
    {% endif %}
  </div>

  <script>
    (function () {
      const token = {{ order.token|tojson }};
      const statusText = document.getElementById('status-text');
      const refreshBtn = document.getElementById('refresh-status');
      const warningEl = document.getElementById('status-warning');

      const statusUrl = {{ status_url|tojson }};

      function statusLabel(rawStatus) {
        const status = String(rawStatus || '').toUpperCase();
        if (status === 'PAID') return 'Pago';
        if (status === 'PENDING') return 'Pendente';
        return rawStatus || '';
      }

      async function refreshStatus() {
        if (!token || !refreshBtn) return;
        refreshBtn.disabled = true;
        refreshBtn.classList.add('is-loading');
        try {
          const res = await fetch(statusUrl);
          if (!res.ok) return;
          const data = await res.json();
          if (!data.ok) return;

          if (data.status && statusText) {
            statusText.textContent = statusLabel(data.status);
            statusText.classList.toggle('status-paid', data.status === 'PAID');
            statusText.classList.toggle('status-pending', data.status !== 'PAID');
          }

          if (warningEl) {
            if (data.warning) {
              warningEl.textContent = data.warning;
              warningEl.style.display = 'block';
            } else {
              warningEl.textContent = '';
              warningEl.style.display = 'none';
            }
          }

          if (data.redirect) {
            window.location.href = data.redirect;
          }
        } catch (e) {
          // silencioso
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.classList.remove('is-loading');
        }
      }

      refreshBtn?.addEventListener('click', refreshStatus);
      refreshStatus();
      setInterval(refreshStatus, 4000);
    })();
  </script>
{% endblock %}
